<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Research Scraper AI (Multi-Model)</title>
    <!-- Styles & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: { slate: { 850: '#151f32' } },
            typography: (theme) => ({
              DEFAULT: {
                css: {
                  color: theme('colors.gray.300'),
                  a: { color: theme('colors.blue.400'), '&:hover': { color: theme('colors.blue.300') } },
                  h1: { color: theme('colors.blue.400'), marginTop: '1.5em', marginBottom: '1em', paddingBottom: '0.5em', borderBottom: '1px solid', borderColor: theme('colors.blue.800'), lineHeight: '1.3' },
                  h2: { color: theme('colors.blue.300'), marginTop: '2em', marginBottom: '1em', lineHeight: '1.3' },
                  h3: { color: theme('colors.blue.200'), marginTop: '1.5em', marginBottom: '0.75em' },
                  strong: { color: theme('colors.gray.100') },
                  blockquote: { borderLeftColor: theme('colors.blue.500'), backgroundColor: 'rgba(59, 130, 246, 0.1)', padding: '1rem', fontStyle: 'italic', marginTop: '1.5em', marginBottom: '1.5em' },
                  code: { color: theme('colors.pink.300') },
                  'code::before': { content: '""' }, 'code::after': { content: '""' },
                  hr: { borderColor: theme('colors.gray.700'), marginTop: '2em', marginBottom: '2em' },
                }
              }
            })
          }
        },
        plugins: [ function({ addBase, theme }) { addBase({ 'h1': { fontSize: theme('fontSize.3xl'), fontWeight: theme('fontWeight.bold') }, 'h2': { fontSize: theme('fontSize.2xl'), fontWeight: theme('fontWeight.bold') }, 'h3': { fontSize: theme('fontSize.xl'), fontWeight: theme('fontWeight.semibold') }, }) } ]
      }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        body { display: block; background-color: #0f172a; }
        html, body { height: 100%; overflow: hidden; }
    </style>
    <!-- Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://unpkg.com/@mozilla/readability@0.5.0/Readability.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
</head>
<body class="text-gray-100 transition-colors duration-200">
    <div id="root" class="h-full w-full"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // CONFIG: TAGS
        const AVAILABLE_TAGS = ["[ PROCESOS ]  Atenci贸n","[ PROCESOS ]  Autonom铆a","[ PROCESOS ]  Carga cognitiva","[ PROCESOS ]  Ciencias del Aprendizaje","[ PROCESOS ]  Creatividad","[ PROCESOS ]  Desarrollo cognitivo","[ PROCESOS ]  Estilos de aprendizaje","[ PROCESOS ]  Funciones ejecutivas","[ PROCESOS ]  Memoria","[ PROCESOS ]  Metacognici贸n","[ PROCESOS ]  Motivaci贸n","[ PROCESOS ]  Neuroeducaci贸n","[ PROCESOS ]  Pensamiento Cr铆tico","[ PROCESOS ]  Psicolog铆a","[ PROCESOS ]  Salud Mental","[ METODOLOGAS ]  Aprendizaje Basado en Proyectos","[ METODOLOGAS ]  Aula del Futuro","[ METODOLOGAS ]  Biblioteca","[ METODOLOGAS ]  Aprendizaje cooperativo","[ METODOLOGAS ]  Aprendizaje Servicio","[ METODOLOGAS ]  Flipped Classroom","[ METODOLOGAS ]  Gamificaci贸n","[ DIDCTICA ]  Competencias clave","[ DIDCTICA ]  Idiomas","[ DIDCTICA ]  Ciencias","[ DIDCTICA ]  Matem谩ticas","[ DIDCTICA ]  Art铆stica","[ DIDCTICA ]  Sociales","[ DIDCTICA ]  Salud","[ DIDCTICA ]  Escritura","[ DIDCTICA ]  Lectura","[ DIDCTICA ]  Lenguaje oral","[ DIVERSIDAD ]  Adaptaciones curriculares","[ DIVERSIDAD ]  Altas Capacidades","[ DIVERSIDAD ]  Autismo","[ DIVERSIDAD ]  Dislexia","[ DIVERSIDAD ]  DUA","[ DIVERSIDAD ]  Educaci贸n Inclusiva","[ DIVERSIDAD ]  Necesidades Educativas Especiales","[ DIVERSIDAD ]  TDAH","[ GESTIN ]  Absentismo escolar","[ GESTIN ]  Bienestar docente","[ GESTIN ]  Curr铆culo","[ GESTIN ]  Formaci贸n del profesorado","[ GESTIN ]  Gesti贸n del aula","[ GESTIN ]  Liderazgo educativo","[ GESTIN ]  Orientaci贸n educativa","[ GESTIN ]  Pol铆tica Educativa","[ GESTIN ]  Rendimiento acad茅mico","[ GESTIN ]  Tutor铆a","[ CONVIVENCIA ]  Acoso escolar","[ CONVIVENCIA ]  Clima de aula","[ CONVIVENCIA ]  Coeducaci贸n","[ CONVIVENCIA ]  Desigualdad educativa","[ CONVIVENCIA ]  Educaci贸n Emocional","[ CONVIVENCIA ]  tica","[ CONVIVENCIA ]  Familia-Escuela","[ CONVIVENCIA ]  Resoluci贸n de conflictos","[ TIC ]  Inteligencia Artificial","[ TIC ]  Pensamiento Computacional","[ TIC ]  Rob贸tica","[ TIC ]  Competencia digital","[ EVALUACIN ]  Evaluaci贸n","[ EVALUACIN ]  Feedback","[ INVESTIGACIN ]  Meta-an谩lisis","[ INVESTIGACIN ]  Revisi贸n Sistem谩tica","[ INVESTIGACIN ]  Teor铆a Fundamentada","[ NIVEL ]  Bachillerato","[ NIVEL ]  Infantil","[ NIVEL ]  Primaria","[ NIVEL ]  Secundaria","[ NIVEL ]  Superior","#Gap","#Seed"].sort();

        //  API CONFIGURATION 
        // Usamos la direcci贸n real de Vercel para que funcione tanto en la web como en local (file://)
        const BASE_URL = "https://research-scraper-mu.vercel.app"; 
        const PROXY_ENDPOINT = `${BASE_URL}/api/proxy`;
        const AI_ENDPOINT = `${BASE_URL}/api/ai`;

        // --- SERVICES ---
        const fetchWithCorsRotation = async (targetUrl, isJson = false) => {
            try {
                const proxyUrl = `${PROXY_ENDPOINT}?url=${encodeURIComponent(targetUrl)}`;
                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error(`Proxy Error: ${res.status}`);
                if (isJson) {
                    const textData = await res.text();
                    try { return JSON.parse(textData); } catch (e) { return textData; }
                }
                return await res.text();
            } catch (e) {
                console.error(e);
                throw new Error("Error de conexi贸n con el Proxy.");
            }
        };

        const fetchImageBlob = async (url) => {
            try {
                const proxyUrl = `${PROXY_ENDPOINT}?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxyUrl);
                if (res.ok) return await res.blob();
            } catch {}
            throw new Error("Image download failed");
        };

        const callServerAI = async (text, provider) => {
            const response = await fetch(AI_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text, preferredProvider: provider })
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || "Error en el servidor de IA");
            }
            return await response.json();
        };

        // --- UTILS ---
        // @ts-ignore
        const domPurify = window.DOMPurify;
        // @ts-ignore
        marked.setOptions({ gfm: true, breaks: true });
        const ViewMode = { EDIT: 'EDIT', PREVIEW: 'PREVIEW', SPLIT: 'SPLIT' };
        const getCurrentDate = () => new Date().toISOString().split('T')[0];
        const generateApa = (fm) => {
            if (!fm) return '';
            const cleanAuthor = (fm.author || 'Unknown').trim();
            const year = fm.date ? fm.date.split('-')[0] : 'n.d.';
            const cleanTitle = (fm.title || 'Untitled').replace(/\*/g, '').trim();
            let siteName = '';
            try {
                if (fm.source && fm.source.startsWith('http')) {
                    siteName = new URL(fm.source).hostname.replace('www.', '');
                    siteName = siteName + '. ';
                }
            } catch (e) {}
            return `${cleanAuthor} (${year}). *${cleanTitle}*. ${siteName}${fm.source}`;
        };
        const stringifyFrontmatter = (fm) => {
            const tagsString = fm.tags && fm.tags.length ? fm.tags.map(t => `  - ${t}`).join('\n') : '';
            return `---
title: "${(fm.title || '').replace(/"/g, '\\"')}"
author: "${(fm.author || '').replace(/"/g, '\\"')}"
date: ${fm.date}
created: ${fm.created}
source: "${fm.source}"
source_type: ${fm.source_type}
tags:
${tagsString}
---`;
        };
        const generateFilename = (fm) => {
            const cleanAuthor = (fm.author || 'Unknown').trim();
            const year = fm.date ? fm.date.split('-')[0] : 'nd';
            const cleanTitle = (fm.title || 'Untitled').replace(/[^\w\s\u00C0-\u017F-]/g, '').trim();
            return `${cleanAuthor}. (${year}). ${cleanTitle}.md`;
        };
        const parseYamlFromText = (text) => {
            const match = text.match(/^---\n([\s\S]*?)\n---/);
            if (!match) return null;
            const yamlText = match[1];
            const extract = (key) => {
                const r = new RegExp(`^${key}:\\s*(.*)$`, 'm');
                const m = yamlText.match(r);
                if (m) return m[1].replace(/^"(.*)"$/, '$1').trim();
                return '';
            };
            const tags = [];
            const tagMatch = yamlText.match(/^tags:\s*([\s\S]*?)(?=$|^\w+:)/m);
            if (tagMatch) {
                const tagLines = tagMatch[1].split('\n');
                tagLines.forEach(l => { const t = l.trim().replace(/^-\s*/, ''); if (t) tags.push(t); });
            }
            return { title: extract('title'), author: extract('author'), date: extract('date'), created: extract('created'), source: extract('source'), source_type: extract('source_type'), tags: tags };
        };

        // --- PARSERS ---
        const processRedditJson = (jsonStr, url) => {
            try {
                const data = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
                const post = data[0].data.children[0].data;
                const comments = data[1].data.children;
                let imageUrls = [];
                if (post.media_metadata) { Object.values(post.media_metadata).forEach(m => { if(m.s && m.s.u) imageUrls.push(m.s.u.replace(/&amp;/g, '&')); }); }
                else if (post.url && post.url.match(/\.(jpg|png|gif)$/)) { imageUrls.push(post.url.replace(/&amp;/g, '&')); }
                else if (post.preview && post.preview.images && post.preview.images[0]) { imageUrls.push(post.preview.images[0].source.url.replace(/&amp;/g, '&')); }
                let md = `**Subreddit:** r/${post.subreddit}\n\n${post.selftext||''}\n\n`;
                imageUrls.forEach(img => { md += `![Reddit Image](${img})\n\n`; });
                md += `---\n\n### Comments\n\n`;
                const proc = (list, depth=0) => {
                    let t = "";
                    list.forEach(c => {
                        if(c.data.body) {
                            const ind = "> ".repeat(depth+1);
                            t += `${ind}**${c.data.author}**: ${c.data.body.replace(/\n/g,'\n'+ind)}\n\n`;
                            if(c.data.replies?.data?.children) t += proc(c.data.replies.data.children, depth+1);
                        }
                    });
                    return t;
                };
                md += proc(comments);
                return { markdown: md, textContent: md, title: post.title, author: post.author, date: new Date(post.created_utc*1000).toISOString().split('T')[0], tags: ['reddit', post.subreddit] };
            } catch { throw new Error("Reddit parse error"); }
        };
        const processFxTwitter = async (url) => {
             try {
                const match = url.match(/(?:twitter|x)\.com\/(?:#!\/)?(\w+)\/status(?:es)?\/(\d+)/);
                if (!match) throw new Error("Invalid Twitter URL");
                const tweetId = match[2];
                const fxUrl = `https://api.fxtwitter.com/i/status/${tweetId}`;
                const jsonStr = await fetchWithCorsRotation(fxUrl, true);
                const data = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
                if (!data || !data.tweet) throw new Error("Tweet not found");
                const t = data.tweet;
                let markdown = `**Tweet by ${t.author.name}** (@${t.author.screen_name})\n\n> ${t.text}\n\n`;
                if (t.media?.photos) t.media.photos.forEach(p => markdown += `![Tweet Image](${p.url})\n\n`);
                if (t.media?.videos) t.media.videos.forEach(v => markdown += `![Video Thumbnail](${v.thumbnail_url})  \n*[Video Link](${v.url})*\n\n`);
                markdown += `[View on X](${t.url})`;
                const dateStr = t.created_at ? new Date(t.created_at).toISOString().split('T')[0] : '';
                return { markdown, textContent: t.text, title: `Tweet by ${t.author.name}`, author: t.author.name, rawHtml: '', metaDate: dateStr, tags: ['twitter', t.author.screen_name] };
            } catch (e) { throw new Error("Twitter Error"); }
        };
        const htmlToMarkdown = async (htmlOrUrl, url, isRawHtml) => {
            if (url.includes('twitter.com') || url.includes('x.com')) return processFxTwitter(url);
            if (url.includes('reddit.com')) {
                const jsonUrl = url.split('?')[0].replace(/\/$/, '')+'.json';
                const json = await fetchWithCorsRotation(jsonUrl, true);
                return processRedditJson(json, url);
            }
            let html = htmlOrUrl;
            if (!isRawHtml) html = await fetchWithCorsRotation(url);
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const base = doc.createElement('base'); base.href = url; doc.head.appendChild(base);
            const kw = doc.querySelector('meta[name="keywords"]');
            const tags = kw ? kw.getAttribute('content').split(',').map(s=>s.trim()) : [];
            const reader = new Readability(doc, { classesToPreserve: ['tweet', 'post'] });
            const art = reader.parse() || { content: '', title: 'Untitled', textContent: '' };
            const turndown = new TurndownService({ headingStyle: 'atx', codeBlockStyle: 'fenced' });
            turndown.keep(['table', 'tr', 'td']);
            turndown.addRule('imgs', { filter: 'img', replacement: (_, node) => {
                const src = node.getAttribute('src');
                if(!src) return '';
                try { return `![${node.getAttribute('alt')||''}](${new URL(src, url).href})`; } catch { return ''; }
            }});
            return { markdown: turndown.turndown(art.content), textContent: art.textContent, title: art.title, author: art.byline, rawHtml: html, tags };
        };
        const parsePdf = async (file) => {
            const buf = await file.arrayBuffer();
            // @ts-ignore
            const pdf = await pdfjsLib.getDocument({data: buf}).promise;
            let txt = '';
            const meta = await pdf.getMetadata();
            for(let i=1; i<=pdf.numPages; i++) {
                const p = await pdf.getPage(i);
                const c = await p.getTextContent();
                txt += '\n\n' + c.items.map(s=>s.str).join(' ');
            }
            return { text: txt, metadata: meta };
        };
        const extractDateFromText = (text, html) => {
            const suggestions = new Set();
            const scanText = text.substring(0, 5000);
            const patterns = [ /\b\d{4}-\d{2}-\d{2}\b/g, /\b\d{1,2}[/.-]\d{1,2}[/.-]\d{4}\b/g, /\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4}\b/gi, /\b\d{1,2}\s+de\s+(?:enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)\s+(?:de\s+)?\d{4}\b/gi ];
            patterns.forEach(regex => {
                const matches = scanText.match(regex) || [];
                matches.forEach(m => {
                    let dateStr = m;
                    if (dateStr.match(/de/i)) {
                        const esMonths = {enero:'Jan',febrero:'Feb',marzo:'Mar',abril:'Apr',mayo:'May',junio:'Jun',julio:'Jul',agosto:'Aug',septiembre:'Sep',octubre:'Oct',noviembre:'Nov',diciembre:'Dec'};
                        dateStr = dateStr.replace(/\b(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)\b/gi, match => esMonths[match.toLowerCase()]).replace(/\s+de\s+/gi, ' ');
                    }
                    const d = new Date(dateStr);
                    if (!isNaN(d.getTime())) suggestions.add(d.toISOString().split('T')[0]);
                });
            });
            return Array.from(suggestions).sort((a,b) => new Date(b) - new Date(a));
        };
        const analyzeContent = (data, sourceUrl, type, pdfMeta) => {
            let title='Untitled', author='Unknown', date='', tags=['research'], sDates=[];
            if(type==='web') {
                title = data.title || title;
                author = (data.author||'').replace(/^By /i,'').trim() || 'Unknown';
                if(author==='Unknown' && data.rawHtml) {
                    const m = new DOMParser().parseFromString(data.rawHtml, 'text/html').querySelector('meta[name="author"]');
                    if(m) author = m.getAttribute('content');
                }
                sDates = extractDateFromText(data.textContent, data.rawHtml);
                if(data.metaDate) { date = data.metaDate; if(!sDates.includes(date)) sDates.unshift(date); }
                else if(sDates.length > 0) { date = sDates[0]; }
                if(data.tags && data.tags.length > 0) tags = data.tags.slice(0,5); else tags = ['web'];
            } else {
                if(pdfMeta?.info) {
                    title = pdfMeta.info.Title || title;
                    author = pdfMeta.info.Author || author;
                    if(pdfMeta.info.CreationDate?.startsWith('D:')) {
                        const cd = pdfMeta.info.CreationDate;
                        date = `${cd.substring(2,6)}-${cd.substring(6,8)}-${cd.substring(8,10)}`;
                        sDates.push(date);
                    }
                }
                const txtDates = extractDateFromText(data);
                sDates = [...sDates, ...txtDates];
                if(!date && sDates.length > 0) date = sDates[0];
                tags = ['pdf'];
            }
            sDates = Array.from(new Set(sDates)).sort((a,b)=>new Date(b)-new Date(a));
            if(!date && sDates.length) date = sDates[0];
            const urlMatch = sourceUrl.match(/(\d{4})[\/-](\d{2})[\/-](\d{2})/);
            if (!date && urlMatch) { date = `${urlMatch[1]}-${urlMatch[2]}-${urlMatch[3]}`; if(!sDates.includes(date)) sDates.push(date); }
            const fm = { title: title.replace(/"/g,''), author: author, date, created: getCurrentDate(), source: sourceUrl, source_type: type, tags };
            const citation = generateApa(fm);
            return { fm, citation, sDates };
        };

        // --- COMPONENTS ---
        const MetadataModal = ({ isOpen, onClose, fm, onSave, sDates }) => {
            const [f, setF] = useState(fm);
            const [q, setQ] = useState('');
            useEffect(()=>setF(fm),[fm,isOpen]);
            if(!isOpen) return null;
            const addT = t => { const clean = t.trim(); if(!f.tags.includes(clean)) setF({...f, tags:[...f.tags, clean]}); setQ(''); };
            const avail = AVAILABLE_TAGS.filter(t => t.toLowerCase().includes(q.toLowerCase()) && !f.tags.includes(t));
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
                    <div className="bg-slate-800 rounded-xl w-full max-w-lg flex flex-col max-h-[90vh] border border-slate-700 shadow-2xl">
                        <div className="p-4 border-b border-slate-700 flex justify-between"><h2 className="text-lg font-bold text-white">Edit Metadata</h2><button onClick={onClose}><i className="fas fa-times text-gray-400"></i></button></div>
                        <div className="p-4 overflow-y-auto space-y-3 bg-slate-800">
                            {['title','author','source'].map(k=><div key={k}><label className="text-xs uppercase text-gray-400">{k}</label><input className="w-full p-2 bg-slate-900 rounded border border-slate-700 text-white" value={f[k]} onChange={e=>setF({...f,[k]:e.target.value})} /></div>)}
                            <div><label className="text-xs uppercase text-gray-400">Date</label><div className="flex gap-2"><input type="date" className="flex-1 p-2 bg-slate-900 rounded border border-slate-700 text-white" value={f.date} onChange={e=>setF({...f,date:e.target.value})} />{sDates.length>0 && <div className="relative group"><button className="h-full px-3 bg-slate-700 rounded"><i className="fas fa-magic text-blue-400"></i></button><div className="absolute bottom-full right-0 mb-2 w-40 bg-slate-700 shadow-lg p-2 hidden group-hover:block z-20 border border-slate-600 rounded"><p className="text-xs text-gray-400 p-1 border-b border-slate-600 mb-1">Found in text:</p>{sDates.map(d=><button key={d} onClick={()=>setF({...f,date:d})} className="block w-full text-left text-xs p-1 hover:bg-slate-600 text-white rounded">{d}</button>)}</div></div>}</div></div>
                            <div>
                                <label className="text-xs uppercase text-gray-400 block mb-1">Tags</label>
                                <div className="flex flex-wrap gap-1 mb-2 min-h-[30px] bg-slate-900/50 p-2 rounded">{f.tags.map(t=><span key={t} className="px-2 py-0.5 bg-blue-900 text-blue-200 rounded-full text-xs flex items-center gap-1">{t}<button onClick={()=>setF({...f,tags:f.tags.filter(x=>x!==t)})}>&times;</button></span>)}</div>
                                <input placeholder="Search tags..." value={q} onChange={e=>setQ(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&q)addT(q)}} className="w-full p-2 bg-slate-900 rounded border border-slate-700 text-sm text-white" />
                                <div className="mt-3"><p className="text-xs text-gray-500 mb-2 uppercase">Available Tags</p><div className="flex flex-wrap gap-1 max-h-32 overflow-y-auto p-1">{avail.map(t=><button key={t} onClick={()=>addT(t)} className="px-2 py-1 bg-slate-700 rounded-full text-xs hover:bg-slate-600 text-gray-300">+ {t}</button>)}</div></div>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-700 text-right gap-2 flex justify-end bg-slate-800 rounded-b-xl"><button onClick={onClose} className="px-4 py-2 bg-slate-700 rounded text-white hover:bg-slate-600">Cancel</button><button onClick={()=>{onSave(f);onClose()}} className="px-4 py-2 bg-blue-600 rounded text-white hover:bg-blue-500">Save</button></div>
                    </div>
                </div>
            );
        };

        const ImageManager = ({ isOpen, onClose, md, name }) => {
            const [imgs, setImgs] = useState([]);
            const [proc, setProc] = useState(false);
            const [status, setStatus] = useState('');
            useEffect(() => {
                if(isOpen && md) {
                    const matches = [...md.matchAll(/!\[(.*?)\]\((.*?)\)/g)].map(m=>({alt:m[1]||'img', url:m[2], sel:true}));
                    setImgs(matches.filter((v,i,a)=>a.findIndex(x=>x.url===v.url)===i));
                }
            }, [isOpen, md]);
            if(!isOpen) return null;
            const dl = async () => {
                const sel = imgs.filter(i=>i.sel);
                if(!sel.length) return;
                setProc(true);
                try {
                    // @ts-ignore
                    const zip = new JSZip();
                    const f = zip.folder("images");
                    let ok=0;
                    for(let i=0; i<sel.length; i++) {
                        setStatus(`Downloading ${i+1}/${sel.length}...`);
                        try {
                            const b = await fetchImageBlob(sel[i].url);
                            const ext = sel[i].url.split('.').pop().split('?')[0].substring(0,4) || 'jpg';
                            f.file(`img_${i+1}.${ext}`, b);
                            ok++;
                        } catch(e) { console.error(e); }
                    }
                    setStatus('Compressing...');
                    const c = await zip.generateAsync({type:"blob"});
                    const a = document.createElement('a'); a.href=URL.createObjectURL(c); a.download=`${name}_images.zip`; a.click();
                    setStatus(`Done! ${ok} saved.`);
                    setTimeout(()=>onClose(), 1500);
                } catch(e) { setStatus('Error: ' + e.message); }
                setProc(false);
            };
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
                    <div className="bg-slate-800 rounded-xl w-full max-w-2xl flex flex-col max-h-[80vh] border border-slate-700 shadow-2xl">
                        <div className="p-4 border-b border-slate-700 flex justify-between"><h3 className="font-bold text-white">Images</h3><button onClick={onClose}><i className="fas fa-times"></i></button></div>
                        <div className="p-2 flex justify-between bg-slate-900"><button onClick={()=>setImgs(imgs.map(i=>({...i,sel:true})))} className="text-xs text-blue-400">Select All</button><span className="text-xs text-gray-400">{imgs.filter(i=>i.sel).length} selected</span></div>
                        <div className="p-4 grid grid-cols-3 gap-4 overflow-y-auto flex-1 bg-slate-800">
                            {imgs.length===0 ? <div className="col-span-3 text-center text-gray-500 py-10">No images found</div> :
                            imgs.map((x,i)=><div key={i} onClick={()=>setImgs(imgs.map((m,j)=>j===i?{...m,sel:!m.sel}:m))} className={`aspect-square border-2 rounded cursor-pointer relative ${x.sel?'border-blue-500':'border-transparent opacity-50'}`}><img src={x.url} className="w-full h-full object-cover rounded-sm" /></div>)}
                        </div>
                        <div className="p-4 border-t border-slate-700 flex justify-between items-center bg-slate-800 rounded-b-xl"><span className="text-sm animate-pulse text-blue-400">{status}</span><button onClick={dl} disabled={proc || !imgs.filter(i=>i.sel).length} className="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded disabled:opacity-50">Download Zip</button></div>
                    </div>
                </div>
            );
        };

        // --- NEW: AI SELECTION MODAL ---
        const AISelectionModal = ({ isOpen, onClose, onSelect, loading }) => {
            if(!isOpen) return null;
            
            const models = [
                { id: 'google', name: 'Google Gemini 2.0', desc: 'R谩pido, creativo y gran contexto.', color: 'from-blue-600 to-blue-400', icon: 'fa-google' },
                { id: 'groq', name: 'Groq Llama 3.3', desc: 'S煤per r谩pido y objetivo.', color: 'from-orange-600 to-orange-400', icon: 'fa-bolt' },
                { id: 'sambanova', name: 'Llama 3.1 405B', desc: 'El "cerebrito" open-source m谩s potente.', color: 'from-purple-600 to-purple-400', icon: 'fa-brain' },
                { id: 'cohere', name: 'Cohere Command R+', desc: 'Especialista en res煤menes empresariales.', color: 'from-teal-600 to-teal-400', icon: 'fa-briefcase' }
            ];

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-slate-800 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl overflow-hidden transform transition-all scale-100">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                            <h3 className="font-bold text-white flex items-center gap-2"><i className="fas fa-robot text-blue-400"></i> Elegir Cerebro IA</h3>
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center text-gray-300 transition"><i className="fas fa-times"></i></button>
                        </div>
                        <div className="p-4 space-y-3">
                            {models.map(m => (
                                <button key={m.id} onClick={() => onSelect(m.id)} disabled={loading} 
                                    className="w-full text-left p-4 rounded-xl bg-slate-700/50 hover:bg-slate-700 border border-slate-600 hover:border-blue-500/50 transition group relative overflow-hidden">
                                    <div className={`absolute inset-0 bg-gradient-to-r ${m.color} opacity-0 group-hover:opacity-10 transition duration-300`}></div>
                                    <div className="flex items-center gap-4 relative z-10">
                                        <div className={`w-10 h-10 rounded-lg bg-gradient-to-br ${m.color} flex items-center justify-center shadow-lg`}>
                                            <i className={`fab ${m.icon === 'fa-bolt' ? 'fas' : ''} ${m.icon} text-white text-lg`}></i>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-gray-100">{m.name}</h4>
                                            <p className="text-xs text-gray-400 mt-0.5">{m.desc}</p>
                                        </div>
                                        <i className="fas fa-chevron-right ml-auto text-slate-500 group-hover:text-blue-400 transition"></i>
                                    </div>
                                </button>
                            ))}
                        </div>
                        <div className="p-3 bg-slate-900/50 text-center border-t border-slate-700">
                            <p className="text-xs text-gray-500">Todos los modelos son gratuitos</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [st, setSt] = useState('idle');
            const [msg, setMsg] = useState('');
            const [final, setFinal] = useState('');
            const [fm, setFm] = useState(null);
            const [currentPdf, setCurrentPdf] = useState(null);
            const [sDates, setSDates] = useState([]);
            const [view, setView] = useState(window.innerWidth<768?ViewMode.PREVIEW:ViewMode.SPLIT);
            const [modals, setModals] = useState({meta:false, imgs:false, ai:false});
            const [copied, setCopied] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);

            const handleEditorChange = (e) => {
                const newVal = e.target.value;
                setFinal(newVal);
                const newFm = parseYamlFromText(newVal);
                if (newFm) {
                    setFm(prev => ({...prev, ...newFm}));
                    const newApa = generateApa(newFm);
                    const apaRegex = /(# CITA APA\n\n> )(.*)/;
                    const match = newVal.match(apaRegex);
                    if (match && match[2] !== newApa) {
                        const updatedText = newVal.replace(apaRegex, `$1${newApa}`);
                        setFinal(updatedText);
                    }
                }
            };
            const handleMetadataSave = (newFm) => {
                setFm(newFm);
                const parts = final.split('---');
                if (parts.length >= 3) {
                    const bodyWithApa = parts.slice(2).join('---');
                    const bodyOnly = bodyWithApa.replace(/# CITA APA[\s\S]*$/, '');
                    const newYaml = stringifyFrontmatter(newFm);
                    const newApa = generateApa(newFm);
                    const reconstructed = `${newYaml}${bodyOnly.trim()}\n\n\n\n# CITA APA\n\n> ${newApa}`;
                    setFinal(reconstructed);
                }
            };

            const executeAI = async (providerId) => {
                setModals({...modals, ai: false}); // Cerrar modal
                
                const parts = final.split('---');
                if (parts.length < 3) return;
                const bodyContent = parts.slice(2).join('---').replace(/# RESUMEN[\s\S]*?# CONTENIDO/, '# CONTENIDO').replace(/# CITA APA[\s\S]*$/, '');
                
                setAiLoading(true);
                try {
                    const result = await callServerAI(bodyContent, providerId);
                    
                    const uniqueTags = [...new Set([...(fm.tags || []), ...(result.suggestedTags || [])])];
                    const newFm = { ...fm, tags: uniqueTags };
                    setFm(newFm); 
                    const newYaml = stringifyFrontmatter(newFm);
                    const summaryBlock = `# RESUMEN\n\n${result.summary}\n\n### Puntos Clave\n\n${result.keyPoints}`;
                    const contentMarker = "# CONTENIDO";
                    const parts2 = final.split(contentMarker);
                    if (parts2.length < 2) throw new Error("No encuentro la secci贸n # CONTENIDO");
                    const contentAndRest = parts2.slice(1).join(contentMarker);
                    const apaBlock = `# CITA APA\n\n> ${generateApa(newFm)}`;
                    const cleanContent = contentAndRest.replace(/# CITA APA[\s\S]*$/, '').trim();
                    const newDoc = `${newYaml}\n\n${summaryBlock}\n\n\n\n${contentMarker}\n\n${cleanContent}\n\n\n\n${apaBlock}`;
                    setFinal(newDoc);
                } catch (e) {
                    alert(`Error con el proveedor seleccionado: ${e.message}\n\nInt茅ntalo de nuevo.`);
                }
                setAiLoading(false);
            };

            const downloadRenamedPdf = () => {
                if(!currentPdf || !fm) return;
                const name = generateFilename(fm).replace('.md', '.pdf');
                const url = URL.createObjectURL(currentPdf);
                const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
            };

            const process = async (type, input) => {
                setSt('scraping'); setMsg('Processing...');
                try {
                    let res, text, meta;
                    if(type==='url') {
                        setCurrentPdf(null);
                        res = await htmlToMarkdown('', input, false);
                        text = res.markdown;
                        meta = analyzeContent(res, input, 'web');
                    } else {
                        setCurrentPdf(input);
                        const pdf = await parsePdf(input);
                        text = pdf.text;
                        meta = analyzeContent(text, input.name, 'pdf', pdf.metadata);
                    }
                    setFm(meta.fm); setSDates(meta.sDates);
                    const content = `${stringifyFrontmatter(meta.fm)}\n\n# RESUMEN\n\n\n\n# CONTENIDO\n\n${text}\n\n# NOTAS\n\n\n\n# CITA APA\n\n> ${meta.citation}`;
                    setFinal(content);
                    setSt('success');
                    if(window.innerWidth<768) setView(ViewMode.PREVIEW);
                } catch(e) { setSt('error'); setMsg(e.message); }
            };

            const renderPreview = () => {
                if(!fm) return null;
                const contentWithoutFm = final.replace(/^---\n[\s\S]*?\n---\n/, '');
                const bodyHtml = domPurify.sanitize(marked.parse(contentWithoutFm || ''));
                return (
                    <div className="space-y-8 pb-20">
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-lg relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-10"><i className={`fas ${fm.source_type==='pdf'?'fa-file-pdf':'fa-globe'} text-6xl`}></i></div>
                            <h1 className="text-2xl font-bold text-white mb-2 relative z-10 !border-none !pb-0 !mb-2 !mt-0">{fm.title}</h1>
                            <div className="flex flex-wrap gap-4 text-sm text-gray-400 mb-4 relative z-10">
                                <div className="flex items-center gap-2"><i className="fas fa-user"></i> {fm.author}</div>
                                <div className="flex items-center gap-2"><i className="fas fa-calendar"></i> {fm.date}</div>
                                <a href={fm.source} target="_blank" className="flex items-center gap-2 text-blue-400 hover:underline truncate max-w-xs"><i className="fas fa-link"></i> Source</a>
                            </div>
                            <div className="flex flex-wrap gap-2 relative z-10">
                                {fm.tags.map(t=><span key={t} className="px-2 py-1 bg-indigo-900 text-indigo-200 text-xs rounded-full border border-indigo-700">#{t}</span>)}
                            </div>
                        </div>
                        <div className="prose prose-invert max-w-none">
                            <div dangerouslySetInnerHTML={{__html: bodyHtml}}></div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-screen flex flex-col font-sans bg-slate-900">
                    <nav className="bg-slate-900 border-b border-slate-800 p-3 flex justify-between items-center sticky top-0 z-30 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded flex items-center justify-center shadow"><i className="fas fa-book-open text-white"></i></div>
                            <h1 className="font-bold text-lg bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">ResearchScraper <span className="text-xs bg-slate-800 text-blue-300 px-1 py-0.5 rounded border border-blue-900 ml-1">Multi-AI</span></h1>
                        </div>
                    </nav>
                    <main className="flex-1 flex flex-col overflow-hidden max-w-[1600px] mx-auto w-full relative">
                        {st !== 'success' ? (
                            <div className="flex-1 overflow-y-auto p-4 flex items-center justify-center">
                                <div className="w-full max-w-2xl bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-8 border border-slate-700 my-4">
                                    <h2 className="text-xl md:text-2xl font-bold mb-4 md:mb-6 text-center text-white">Extract Content</h2>
                                    <div className="space-y-4 md:space-y-6">
                                        <form onSubmit={e=>{e.preventDefault();process('url',e.target.elements.url.value)}} className="flex flex-col sm:flex-row gap-2">
                                            <input name="url" type="url" placeholder="Paste article URL..." className="flex-1 p-3 md:p-4 rounded-xl bg-slate-900 border border-slate-600 focus:border-blue-500 outline-none transition text-white" required />
                                            <button disabled={st==='scraping'} className="px-6 py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-blue-800 rounded-xl font-bold transition shadow-lg shadow-blue-600/20 text-white flex items-center justify-center gap-2 min-w-[120px]">
                                                {st==='scraping' ? <><i className="fas fa-spinner fa-spin"></i> Processing...</> : <><i className="fas fa-search"></i> Scrape</>}
                                            </button>
                                        </form>
                                        <div className="relative flex py-2 items-center"><div className="flex-grow border-t border-slate-600"></div><span className="flex-shrink-0 mx-4 text-slate-400 text-sm">OR</span><div className="flex-grow border-t border-slate-600"></div></div>
                                        <div className="relative border-2 border-dashed border-slate-600 rounded-xl p-6 md:p-8 text-center hover:bg-slate-700/50 transition group cursor-pointer">
                                            <input type="file" accept=".pdf" onChange={e=>e.target.files[0]&&process('pdf',e.target.files[0])} className="absolute inset-0 opacity-0 cursor-pointer" />
                                            <i className="fas fa-file-pdf text-4xl text-slate-500 group-hover:text-red-400 mb-3 transition"></i>
                                            <p className="text-slate-300 font-medium">Drop PDF here or click to upload</p>
                                        </div>
                                    </div>
                                    {st === 'error' && <div className="mt-6 text-center text-red-400 bg-red-900/20 p-3 rounded-lg border border-red-900">{msg}</div>}
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col overflow-hidden animate-fade-in">
                                <div className="bg-slate-800 border-b border-slate-700 p-2 flex flex-col gap-2 shrink-0 z-20 shadow-sm">
                                    <div className="flex flex-wrap gap-2 justify-center sm:justify-start items-center">
                                        <button onClick={()=>setModals({...modals,meta:true})} className="btn px-3 py-1.5 bg-indigo-900/50 text-indigo-300 rounded hover:bg-indigo-900 border border-indigo-900/50 text-sm"><i className="fas fa-tags mr-1"></i> Metadata</button>
                                        <button onClick={()=>setModals({...modals,imgs:true})} className="btn px-3 py-1.5 bg-purple-900/50 text-purple-300 rounded hover:bg-purple-900 border border-purple-900/50 text-sm"><i className="fas fa-images mr-1"></i> Images</button>
                                        
                                        {/* BOTN MGICO QUE ABRE EL MEN */}
                                        <button 
                                            onClick={() => setModals({...modals, ai: true})} 
                                            disabled={aiLoading}
                                            className="px-3 py-1.5 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded text-sm font-bold shadow-lg shadow-purple-500/20 border border-blue-500 transition-all flex items-center gap-2"
                                        >
                                            {aiLoading ? <><i className="fas fa-spinner fa-spin"></i> Thinking...</> : <><i className="fas fa-magic"></i> AI Analyze</>}
                                        </button>

                                        <button onClick={()=>{setSt('idle');setFm(null)}} className="btn px-3 py-1.5 bg-slate-700 text-gray-300 rounded hover:bg-slate-600 border border-slate-600 text-sm"><i className="fas fa-redo mr-1"></i> New</button>
                                        <div className="flex-grow hidden sm:block"></div>
                                        {currentPdf && <button onClick={downloadRenamedPdf} className="px-3 py-1.5 bg-red-900/50 hover:bg-red-900 text-red-200 rounded text-sm font-bold border border-red-800"><i className="fas fa-file-pdf mr-1"></i> PDF</button>}
                                        <button onClick={()=>{navigator.clipboard.writeText(generateApa(fm));setCopied(true);setTimeout(()=>setCopied(false),2000)}} className={`px-3 py-1.5 rounded text-sm font-bold transition flex items-center ${copied?'bg-green-600 text-white':'bg-yellow-900/50 text-yellow-200 hover:bg-yellow-900 border border-yellow-900'}`}><i className="fas fa-quote-right mr-1"></i> {copied?'Copied!':'APA'}</button>
                                        <button onClick={()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([final],{type:'text/markdown'}));a.download=generateFilename(fm);a.click()}} className="px-3 py-1.5 bg-green-700 hover:bg-green-600 text-white rounded text-sm font-bold shadow border border-green-600"><i className="fas fa-download mr-1"></i> Export</button>
                                    </div>
                                    <div className="flex justify-center sm:justify-start">
                                        <div className="flex bg-slate-900 rounded p-1 border border-slate-700">
                                            {[ViewMode.EDIT, ViewMode.SPLIT, ViewMode.PREVIEW].map(m=><button key={m} onClick={()=>setView(m)} className={`px-4 py-1 text-xs rounded font-medium transition ${view===m?'bg-slate-700 text-white shadow':'text-gray-500 hover:text-gray-300'}`}>{m}</button>)}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex-1 flex overflow-hidden relative">
                                    <div className={`${view===ViewMode.PREVIEW?'hidden':'flex-1'} h-full bg-slate-900 border-r border-slate-800`}><textarea value={final} onChange={handleEditorChange} className="w-full h-full bg-slate-900 text-gray-300 p-4 md:p-6 outline-none resize-none font-mono text-sm leading-relaxed" spellCheck="false" /></div>
                                    <div className={`${view===ViewMode.EDIT?'hidden':'flex-1'} h-full bg-slate-850 overflow-y-auto p-4 md:p-8`}>{renderPreview()}</div>
                                </div>
                            </div>
                        )}
                    </main>
                    {fm && <MetadataModal isOpen={modals.meta} onClose={()=>setModals({...modals,meta:false})} fm={fm} onSave={handleMetadataSave} sDates={sDates} />}
                    {fm && <ImageManager isOpen={modals.imgs} onClose={()=>setModals({...modals,imgs:false})} md={final} name={generateFilename(fm).replace('.md','')} />}
                    {fm && <AISelectionModal isOpen={modals.ai} onClose={()=>setModals({...modals,ai:false})} onSelect={executeAI} loading={aiLoading} />}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
